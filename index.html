from openpyxl import Workbook
from openpyxl.styles import Font
from openpyxl.chart import LineChart, Reference
from openpyxl.utils import get_column_letter

wb = Workbook()
data_sheet = wb.active
data_sheet.title = "Trade_Data"
dashboard = wb.create_sheet("Dashboard")
capital_sheet = wb.create_sheet("Capital_Tracking")

headers = [
    "Date","Instrument","Setup","Entry","StopLoss","Exit",
    "Risk_Amount","P&L","R_Multiple","Account_Capital","Mistake"
]
data_sheet.append(headers)

for col in range(1, len(headers)+1):
    data_sheet.cell(row=1,column=col).font = Font(bold=True)

# Add R formula for 200 rows
for row in range(2,202):
    data_sheet[f"I{row}"] = f"=IF(G{row}=0,0,H{row}/G{row})"

# Dashboard Metrics
dashboard["A1"]="Total Trades"
dashboard["B1"]="=COUNTA(Trade_Data!A2:A200)"

dashboard["A2"]="Net P&L"
dashboard["B2"]="=SUM(Trade_Data!H2:H200)"

dashboard["A3"]="Total R"
dashboard["B3"]="=SUM(Trade_Data!I2:I200)"

dashboard["A4"]="Win Rate"
dashboard["B4"]="=IF(B1=0,0,COUNTIF(Trade_Data!I2:I200,\">0\")/B1)"

for r in range(1,5):
    dashboard[f"A{r}"].font=Font(bold=True)

# Equity Curve
dashboard["D1"]="Equity Curve"
dashboard["D2"]="=Trade_Data!H2"
for i in range(3,202):
    dashboard[f"D{i}"]=f"=D{i-1}+Trade_Data!H{i}"

chart = LineChart()
chart.title="Equity Curve"
data = Reference(dashboard,min_col=4,min_row=2,max_row=50)
chart.add_data(data)
dashboard.add_chart(chart,"F2")

# Capital Tracking
capital_sheet["A1"]="Starting Capital"
capital_sheet["B1"]=100000

capital_sheet["A3"]="Current Capital"
capital_sheet["B3"]="=B1+SUM(Trade_Data!H2:H200)"

capital_sheet["A5"]="Growth %"
capital_sheet["B5"]="=IF(B1=0,0,(B3-B1)/B1)"

for cell in ["A1","A3","A5"]:
    capital_sheet[cell].font=Font(bold=True)

excel_path="/mnt/data/Ajay_Trading_Journal_Pro_V2.xlsx"
wb.save(excel_path)


# Create Personal Web App (Responsive Light Theme)

html_content = """
<!DOCTYPE html>
<html>
<head>
<title>Ajay Trading Journal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {font-family: Arial; background:#f4f6f9; margin:20px;}
.card {background:white; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
input {padding:8px; margin:5px 0; width:100%;}
button {padding:10px; width:100%;}
h2 {margin-top:0;}
</style>
</head>
<body>

<h1>Ajay Personal Trading Journal</h1>

<div class="card">
<h2>Add Trade</h2>
<input id="entry" placeholder="Entry Price">
<input id="sl" placeholder="Stop Loss">
<input id="exit" placeholder="Exit Price">
<input id="risk" placeholder="Risk Amount">
<button onclick="addTrade()">Add Trade</button>
</div>

<div class="card">
<h2>Dashboard</h2>
<p>Total Trades: <span id="total">0</span></p>
<p>Total P&L: ₹<span id="pnl">0</span></p>
<p>Total R: <span id="totalR">0</span></p>
<p>Capital: ₹<span id="capital">100000</span></p>
</div>

<script>
let trades = [];
let startingCapital = 100000;

function addTrade(){
    let entry = parseFloat(document.getElementById("entry").value);
    let sl = parseFloat(document.getElementById("sl").value);
    let exit = parseFloat(document.getElementById("exit").value);
    let risk = parseFloat(document.getElementById("risk").value);

    let pnl = (exit - entry) * (risk/(entry-sl));
    let R = pnl / risk;

    trades.push({pnl:pnl,R:R});

    updateDashboard();
}

function updateDashboard(){
    let total = trades.length;
    let totalPnl = trades.reduce((a,b)=>a+b.pnl,0);
    let totalR = trades.reduce((a,b)=>a+b.R,0);

    document.getElementById("total").innerText = total;
    document.getElementById("pnl").innerText = totalPnl.toFixed(2);
    document.getElementById("totalR").innerText = totalR.toFixed(2);
    document.getElementById("capital").innerText = (startingCapital + totalPnl).toFixed(2);
}
</script>

</body>
</html>
"""

html_path="/mnt/data/Ajay_Trading_Journal_App.html"
with open(html_path,"w") as f:
    f.write(html_content)

excel_path, html_path
